{"version":3,"sources":["webpack://projectstorm/react-canvas-core/webpack/universalModuleDefinition","webpack://projectstorm/react-canvas-core/webpack/bootstrap","webpack://projectstorm/react-canvas-core/external \"lodash\"","webpack://projectstorm/react-canvas-core/./src/core-actions/Action.ts","webpack://projectstorm/react-canvas-core/external \"react\"","webpack://projectstorm/react-canvas-core/./src/core/BaseObserver.ts","webpack://projectstorm/react-canvas-core/./src/Toolkit.ts","webpack://projectstorm/react-canvas-core/./src/core-state/AbstractDisplacementState.ts","webpack://projectstorm/react-canvas-core/./src/core-state/State.ts","webpack://projectstorm/react-canvas-core/external \"@projectstorm/geometry\"","webpack://projectstorm/react-canvas-core/./src/entities/canvas/CanvasModel.ts","webpack://projectstorm/react-canvas-core/./src/core-models/BaseEntity.ts","webpack://projectstorm/react-canvas-core/./src/core-models/BaseModel.ts","webpack://projectstorm/react-canvas-core/external \"@emotion/styled\"","webpack://projectstorm/react-canvas-core/./src/entities/selection/SelectionLayerModel.ts","webpack://projectstorm/react-canvas-core/./src/core/FactoryBank.ts","webpack://projectstorm/react-canvas-core/./src/core-actions/ActionEventBus.ts","webpack://projectstorm/react-canvas-core/./src/actions/ZoomCanvasAction.ts","webpack://projectstorm/react-canvas-core/./src/actions/DeleteItemsAction.ts","webpack://projectstorm/react-canvas-core/./src/core-state/StateMachine.ts","webpack://projectstorm/react-canvas-core/./src/core/AbstractFactory.ts","webpack://projectstorm/react-canvas-core/./src/core/AbstractModelFactory.ts","webpack://projectstorm/react-canvas-core/./src/core/AbstractReactFactory.tsx","webpack://projectstorm/react-canvas-core/./src/core-models/BasePositionModel.ts","webpack://projectstorm/react-canvas-core/./src/entities/layer/TransformLayerWidget.tsx","webpack://projectstorm/react-canvas-core/./src/entities/layer/SmartLayerWidget.tsx","webpack://projectstorm/react-canvas-core/./src/entities/layer/LayerModel.ts","webpack://projectstorm/react-canvas-core/./src/entities/selection/SelectionBoxWidget.tsx","webpack://projectstorm/react-canvas-core/./src/states/DragCanvasState.ts","webpack://projectstorm/react-canvas-core/./src/states/SelectingState.ts","webpack://projectstorm/react-canvas-core/./src/states/SelectionBoxState.ts","webpack://projectstorm/react-canvas-core/./src/states/MoveItemsState.ts","webpack://projectstorm/react-canvas-core/./src/index.ts","webpack://projectstorm/react-canvas-core/./src/CanvasEngine.ts","webpack://projectstorm/react-canvas-core/external \"closest\"","webpack://projectstorm/react-canvas-core/./src/entities/canvas/CanvasWidget.tsx","webpack://projectstorm/react-canvas-core/external \"@emotion/core\"","webpack://projectstorm/react-canvas-core/./src/entities/selection/SelectionBoxLayerFactory.tsx","webpack://projectstorm/react-canvas-core/./src/widgets/PeformanceWidget.tsx","webpack://projectstorm/react-canvas-core/./src/states/DefaultState.ts"],"names":["root","factory","exports","module","define","amd","window","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","InputType","options","this","id","Toolkit","UID","engine","listeners","fire","k","event","iterateListeners","listener","firing","stopPropagation","fireEventInternal","function","cb","deregister","handle","getListenerHandle","TESTING","TESTING_UID","replace","Math","random","toString","element","selector","document","body","closest","AbstractDisplacementState","State","super","registerAction","Action","type","MOUSE_DOWN","actionEvent","initialX","clientX","initialY","clientY","rel","getRelativePoint","initialXRelative","x","initialYRelative","y","MOUSE_MOVE","buttons","fireMouseMoved","displacementX","displacementY","virtualDisplacementX","getModel","getZoomLevel","virtualDisplacementY","eject","MOUSE_UP","actions","keys","childStates","getStateMachine","popState","state","pushState","getActionEventBus","fireAction","action","push","length","isKeysFullfilled","findStateToActivate","child","_","intersection","previous","getKeys","tryActivateParentState","tryActivateChildState","handler1","KEY_DOWN","handler2","KEY_UP","next","deregisterAction","CanvasModel","BaseEntity","zoom","gridSize","offsetX","offsetY","layers","flatMap","layer","getSelectionEntities","filter","ob","isSelected","forEach","getSelectedEntities","setSelected","values","getModels","setParent","registerListener","entityRemoved","index","indexOf","splice","size","fireEvent","pos","floor","data","models","promises","resolvers","registerModel","model","getID","Promise","resolve","deserialize","layerOb","getFactoryForLayer","generateModel","initialConfig","addLayer","serialize","map","setOffset","BaseObserver","lookupTable","clone","cloneDeep","clearListeners","doClone","locked","entity","BaseModel","parent","getParentCanvasModel","selected","extras","isLocked","SelectionLayerModel","LayerModel","transformed","isSvg","rect","box","FactoryBank","factories","deregisterFactory","Error","setFactoryBank","getType","setEngine","getMouseElement","getActionsForType","toLowerCase","MOUSE_WHEEL","getActionsForEvent","ZoomCanvasAction","getLayers","allowRepaint","oldZoomFactor","scrollDelta","inverseZoom","deltaY","ctrlKey","setZoomLevel","zoomFactor","boundingRect","currentTarget","getBoundingClientRect","clientWidth","width","clientHeight","height","widthDiff","heightDiff","left","top","xFactor","getOffsetX","yFactor","getOffsetY","repaintCanvas","DeleteItemsAction","keyCodes","modifiers","shiftKey","altKey","metaKey","keyCode","isEqual","remove","StateMachine","stateStack","currentState","setState","pop","last","deactivated","old","activated","newState","bank","AbstractModelFactory","AbstractFactory","AbstractReactFactory","BasePositionModel","position","Point","Rectangle","S","shared","css","DivLayer","div","SvgLayer","svg","TransformLayerWidget","React","Component","props","getParent","getOptions","transform","getTransform","style","getTransformStyle","children","SmartLayerWidget","isRepaintEnabled","generateReactWidget","repaintEnabled","modelOb","getChildModelFactoryBank","getFactory","addModel","mapValues","allow","removeLayer","_id","Container","SelectionBoxWidget","DragCanvasState","config","allowDrag","prev","clearSelection","initialCanvasX","initialCanvasY","SelectingState","getModelForEvent","transitionWithEvent","SelectionBoxState","abs","right","bottom","setBox","getBoxDimensions","relative","getRelativeMousePoint","getBoundingBox","bounds","containsPoint","getTopLeft","getBottomRight","MoveItemsState","initialPositions","items","item","point","getPosition","setPosition","getGridPosition","CanvasEngine","eventBus","ActionEventBus","stateMachine","layerFactories","registerFactoryBank","registerDefaultDeleteItemsAction","registerDefaultZoomCanvasAction","repaintDebounceMs","canvasRect","canvas","factoryAdded","setDiagramEngine","factoryRemoved","requestAnimationFrame","promise","repaint","repaintFn","debounce","rendered","scrollWidth","scrollHeight","Canvas","CanvasWidget","ref","createRef","diagramEngineListener","deregisterListener","canvasListener","setCanvas","removeEventListener","keyUp","keyDown","current","list","registerCanvas","forceUpdate","addEventListener","className","onWheel","onMouseDown","onMouseUp","onMouseMove","SelectionBoxLayerFactory","PeformanceWidget","nextProps","nextState","nextContext","performanceTune","serialized","DefaultState"],"mappings":"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","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"projectstorm/react-canvas-core\"] = factory();\n\telse\n\t\troot[\"projectstorm/react-canvas-core\"] = factory();\n})(window, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 30);\n","module.exports = require(\"lodash\");","import { MouseEvent, KeyboardEvent, WheelEvent, SyntheticEvent } from 'react';\nimport { Toolkit } from '../Toolkit';\nimport { CanvasEngine } from '../CanvasEngine';\nimport { BaseModel } from '../core-models/BaseModel';\n\nexport enum InputType {\n\tMOUSE_DOWN = 'mouse-down',\n\tMOUSE_UP = 'mouse-up',\n\tMOUSE_MOVE = 'mouse-move',\n\tMOUSE_WHEEL = 'mouse-wheel',\n\tKEY_DOWN = 'key-down',\n\tKEY_UP = 'key-up'\n}\n\nexport interface Mapping {\n\t[InputType.MOUSE_DOWN]: MouseEvent;\n\t[InputType.MOUSE_UP]: MouseEvent;\n\t[InputType.MOUSE_MOVE]: MouseEvent;\n\t[InputType.MOUSE_WHEEL]: WheelEvent;\n\t[InputType.KEY_DOWN]: KeyboardEvent;\n\t[InputType.KEY_UP]: KeyboardEvent;\n}\n\nexport interface ActionEvent<Event extends SyntheticEvent = SyntheticEvent, Model extends BaseModel = BaseModel> {\n\tevent: Event;\n\tmodel?: Model;\n}\n\nexport interface ActionOptions {\n\ttype: InputType;\n\tfire: (event: ActionEvent<Mapping[this['type']]>) => void;\n}\n\nexport class Action<T extends CanvasEngine = CanvasEngine> {\n\toptions: ActionOptions;\n\tid: string;\n\tengine: T;\n\n\tconstructor(options: ActionOptions) {\n\t\tthis.options = options;\n\t\tthis.id = Toolkit.UID();\n\t}\n\n\tsetEngine(engine: T) {\n\t\tthis.engine = engine;\n\t}\n}\n","module.exports = require(\"react\");","import { Toolkit } from '../Toolkit';\n\nexport interface BaseEvent {\n\tfiring: boolean;\n\tstopPropagation: () => any;\n}\n\nexport interface BaseEventProxy extends BaseEvent {\n\tfunction: string;\n}\n\n/**\n * Listeners are always in the form of an object that contains methods that take events\n */\nexport type BaseListener = {\n\t/**\n\t * Generic event that fires before a specific event was fired\n\t */\n\teventWillFire?: (event: BaseEvent & { function: string }) => void;\n\n\t/**\n\t * Generic event that fires after a specific event was fired (even if it was consumed)\n\t */\n\teventDidFire?: (event: BaseEvent & { function: string }) => void;\n\t/**\n\t * Type for other events that will fire\n\t */\n\t[key: string]: (event: BaseEvent) => any;\n};\n\nexport interface ListenerHandle {\n\t/**\n\t * Used to degister the listener\n\t */\n\tderegister: () => any;\n\t/**\n\t * Original ID of the listener\n\t */\n\tid: string;\n\n\t/**\n\t * Original Listener\n\t */\n\tlistener: BaseListener;\n}\n\n/**\n * Base observer pattern class for working with listeners\n */\nexport class BaseObserver<L extends BaseListener = BaseListener> {\n\tprotected listeners: { [id: string]: L };\n\n\tconstructor() {\n\t\tthis.listeners = {};\n\t}\n\n\tprivate fireEventInternal(fire: boolean, k: keyof L, event: BaseEvent) {\n\t\tthis.iterateListeners((listener) => {\n\t\t\t// returning false here will instruct itteration to stop\n\t\t\tif (!fire && !event.firing) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t// fire selected listener\n\t\t\tif (listener[k]) {\n\t\t\t\tlistener[k](event as BaseEvent);\n\t\t\t}\n\t\t});\n\t}\n\n\tfireEvent<K extends keyof L>(event: Partial<Parameters<L[K]>[0]>, k: keyof L) {\n\t\tevent = {\n\t\t\tfiring: true,\n\t\t\tstopPropagation: () => {\n\t\t\t\tevent.firing = false;\n\t\t\t},\n\t\t\t...event\n\t\t};\n\n\t\t// fire pre\n\t\tthis.fireEventInternal(true, 'eventWillFire', {\n\t\t\t...event,\n\t\t\tfunction: k\n\t\t} as BaseEventProxy);\n\n\t\t// fire main event\n\t\tthis.fireEventInternal(false, k, event as BaseEvent);\n\n\t\t// fire post\n\t\tthis.fireEventInternal(true, 'eventDidFire', {\n\t\t\t...event,\n\t\t\tfunction: k\n\t\t} as BaseEventProxy);\n\t}\n\n\titerateListeners(cb: (listener: L) => any) {\n\t\tfor (let id in this.listeners) {\n\t\t\tconst res = cb(this.listeners[id]);\n\t\t\t// cancel itteration on false\n\t\t\tif (res === false) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tgetListenerHandle(listener: L): ListenerHandle {\n\t\tfor (let id in this.listeners) {\n\t\t\tif (this.listeners[id] === listener) {\n\t\t\t\treturn {\n\t\t\t\t\tid: id,\n\t\t\t\t\tlistener: listener,\n\t\t\t\t\tderegister: () => {\n\t\t\t\t\t\tdelete this.listeners[id];\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\tregisterListener(listener: L): ListenerHandle {\n\t\tconst id = Toolkit.UID();\n\t\tthis.listeners[id] = listener;\n\t\treturn {\n\t\t\tid: id,\n\t\t\tlistener: listener,\n\t\t\tderegister: () => {\n\t\t\t\tdelete this.listeners[id];\n\t\t\t}\n\t\t};\n\t}\n\n\tderegisterListener(listener: L | ListenerHandle) {\n\t\tif (typeof listener === 'object') {\n\t\t\t(listener as ListenerHandle).deregister();\n\t\t\treturn true;\n\t\t}\n\t\tconst handle = this.getListenerHandle(listener);\n\t\tif (handle) {\n\t\t\thandle.deregister();\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n}\n","import * as closest from 'closest';\n\nexport class Toolkit {\n\tstatic TESTING: boolean = false;\n\tstatic TESTING_UID = 0;\n\n\t/**\n\t * Generats a unique ID (thanks Stack overflow :3)\n\t * @returns {String}\n\t */\n\tpublic static UID(): string {\n\t\tif (Toolkit.TESTING) {\n\t\t\tToolkit.TESTING_UID++;\n\t\t\treturn `${Toolkit.TESTING_UID}`;\n\t\t}\n\t\treturn 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n\t\t\tconst r = (Math.random() * 16) | 0;\n\t\t\tconst v = c === 'x' ? r : (r & 0x3) | 0x8;\n\t\t\treturn v.toString(16);\n\t\t});\n\t}\n\n\t/**\n\t * Finds the closest element as a polyfill\n\t */\n\tpublic static closest(element: Element, selector: string) {\n\t\tif (document.body.closest) {\n\t\t\treturn element.closest(selector);\n\t\t}\n\t\treturn closest(element, selector);\n\t}\n}\n","import { State, StateOptions } from './State';\nimport { Action, ActionEvent, InputType } from '../core-actions/Action';\nimport { CanvasEngine } from '../CanvasEngine';\n\nexport interface AbstractDisplacementStateEvent {\n\tdisplacementX: number;\n\tdisplacementY: number;\n\tvirtualDisplacementX: number;\n\tvirtualDisplacementY: number;\n\tevent: React.MouseEvent;\n}\n\nexport abstract class AbstractDisplacementState<E extends CanvasEngine = CanvasEngine> extends State<E> {\n\tinitialX: number;\n\tinitialY: number;\n\tinitialXRelative: number;\n\tinitialYRelative: number;\n\n\tconstructor(options: StateOptions) {\n\t\tsuper(options);\n\t\tthis.registerAction(\n\t\t\tnew Action({\n\t\t\t\ttype: InputType.MOUSE_DOWN,\n\t\t\t\tfire: (actionEvent: ActionEvent<React.MouseEvent>) => {\n\t\t\t\t\tthis.initialX = actionEvent.event.clientX;\n\t\t\t\t\tthis.initialY = actionEvent.event.clientY;\n\t\t\t\t\tconst rel = this.engine.getRelativePoint(actionEvent.event.clientX, actionEvent.event.clientY);\n\t\t\t\t\tthis.initialXRelative = rel.x;\n\t\t\t\t\tthis.initialYRelative = rel.y;\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t\tthis.registerAction(\n\t\t\tnew Action({\n\t\t\t\ttype: InputType.MOUSE_MOVE,\n\t\t\t\tfire: (actionEvent: ActionEvent<React.MouseEvent>) => {\n\t\t\t\t\tconst { event } = actionEvent;\n\n\t\t\t\t\tif (event.buttons === 0) {\n\t\t\t\t\t\t// If buttons is 0, it means the mouse is not down, the user may have released it\n\t\t\t\t\t\t// outside of the canvas, then we eject the state\n\t\t\t\t\t\tthis.eject();\n\t\t\t\t\t\t\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.fireMouseMoved({\n\t\t\t\t\t\tdisplacementX: event.clientX - this.initialX,\n\t\t\t\t\t\tdisplacementY: event.clientY - this.initialY,\n\t\t\t\t\t\tvirtualDisplacementX: (event.clientX - this.initialX) / (this.engine.getModel().getZoomLevel() / 100.0),\n\t\t\t\t\t\tvirtualDisplacementY: (event.clientY - this.initialY) / (this.engine.getModel().getZoomLevel() / 100.0),\n\t\t\t\t\t\tevent: event\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t\tthis.registerAction(\n\t\t\tnew Action({\n\t\t\t\ttype: InputType.MOUSE_UP,\n\t\t\t\tfire: (event: ActionEvent<React.MouseEvent>) => {\n\t\t\t\t\t// when the mouse if up, we eject this state\n\t\t\t\t\tthis.eject();\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t}\n\n\tabstract fireMouseMoved(event: AbstractDisplacementStateEvent);\n}\n","import { CanvasEngine } from '../CanvasEngine';\nimport { Action, ActionEvent, InputType } from '../core-actions/Action';\nimport { SyntheticEvent } from 'react';\nimport * as _ from 'lodash';\n\nexport interface StateOptions {\n\tname: string;\n}\n\nexport abstract class State<E extends CanvasEngine = CanvasEngine> {\n\tprotected engine: E;\n\tprotected actions: Action[];\n\tprotected keys: string[];\n\tprotected options: StateOptions;\n\tprotected childStates: State[];\n\n\tprivate handler1;\n\tprivate handler2;\n\n\tconstructor(options: StateOptions) {\n\t\tthis.actions = [];\n\t\tthis.keys = [];\n\t\tthis.childStates = [];\n\t\tthis.options = options;\n\t}\n\n\tsetEngine(engine: E) {\n\t\tthis.engine = engine;\n\t}\n\n\tgetOptions() {\n\t\treturn this.options;\n\t}\n\n\teject() {\n\t\tthis.engine.getStateMachine().popState();\n\t}\n\n\ttransitionWithEvent(state: State, event: ActionEvent<SyntheticEvent>) {\n\t\tthis.engine.getStateMachine().pushState(state);\n\t\tthis.engine.getActionEventBus().fireAction(event);\n\t}\n\n\tregisterAction(action: Action) {\n\t\tthis.actions.push(action);\n\t}\n\n\ttryActivateParentState(keys: string[]) {\n\t\tif (this.keys.length > 0 && !this.isKeysFullfilled(keys)) {\n\t\t\tthis.eject();\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\ttryActivateChildState(keys: string[]) {\n\t\tconst state = this.findStateToActivate(keys);\n\t\tif (state) {\n\t\t\tthis.engine.getStateMachine().pushState(state);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tfindStateToActivate(keys: string[]) {\n\t\tfor (let child of this.childStates) {\n\t\t\tif (child.isKeysFullfilled(keys)) {\n\t\t\t\treturn child;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tisKeysFullfilled(keys: string[]) {\n\t\treturn _.intersection(this.keys, keys).length === this.keys.length;\n\t}\n\n\tactivated(previous: State) {\n\t\tconst keys = this.engine.getActionEventBus().getKeys();\n\n\t\tif (this.tryActivateParentState(keys) || this.tryActivateChildState(keys)) {\n\t\t\treturn;\n\t\t}\n\n\t\t// perhaps we need to pop again?\n\t\tthis.handler1 = this.engine.getActionEventBus().registerAction(\n\t\t\tnew Action({\n\t\t\t\ttype: InputType.KEY_DOWN,\n\t\t\t\tfire: () => {\n\t\t\t\t\tthis.tryActivateChildState(this.engine.getActionEventBus().getKeys());\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\n\t\tthis.handler2 = this.engine.getActionEventBus().registerAction(\n\t\t\tnew Action({\n\t\t\t\ttype: InputType.KEY_UP,\n\t\t\t\tfire: () => {\n\t\t\t\t\tthis.tryActivateParentState(this.engine.getActionEventBus().getKeys());\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\n\t\tfor (let action of this.actions) {\n\t\t\tthis.engine.getActionEventBus().registerAction(action);\n\t\t}\n\t}\n\n\tdeactivated(next: State) {\n\t\tif (this.handler1) {\n\t\t\tthis.handler1();\n\t\t}\n\t\tif (this.handler2) {\n\t\t\tthis.handler2();\n\t\t}\n\t\t// if this happens, we are going into heirachial state machine mode\n\t\tfor (let action of this.actions) {\n\t\t\tthis.engine.getActionEventBus().deregisterAction(action);\n\t\t}\n\t}\n}\n","module.exports = require(\"@projectstorm/geometry\");","import * as _ from 'lodash';\nimport {\n\tBaseEntity,\n\tBaseEntityEvent,\n\tBaseEntityGenerics,\n\tBaseEntityListener,\n\tBaseEntityOptions,\n\tDeserializeEvent\n} from '../../core-models/BaseEntity';\nimport { LayerModel } from '../layer/LayerModel';\nimport { BaseModel } from '../../core-models/BaseModel';\nimport { CanvasEngine } from '../../CanvasEngine';\n\nexport interface DiagramListener extends BaseEntityListener {\n\toffsetUpdated?(event: BaseEntityEvent<CanvasModel> & { offsetX: number; offsetY: number }): void;\n\n\tzoomUpdated?(event: BaseEntityEvent<CanvasModel> & { zoom: number }): void;\n\n\tgridUpdated?(event: BaseEntityEvent<CanvasModel> & { size: number }): void;\n}\n\nexport interface DiagramModelOptions extends BaseEntityOptions {\n\toffsetX?: number;\n\toffsetY?: number;\n\tzoom?: number;\n\tgridSize?: number;\n}\n\nexport interface CanvasModelGenerics extends BaseEntityGenerics {\n\tLISTENER: DiagramListener;\n\tOPTIONS: DiagramModelOptions;\n\tLAYER: LayerModel;\n}\n\nexport class CanvasModel<G extends CanvasModelGenerics = CanvasModelGenerics> extends BaseEntity<G> {\n\tprotected layers: G['LAYER'][];\n\n\tconstructor(options: G['OPTIONS'] = {}) {\n\t\tsuper({\n\t\t\tzoom: 100,\n\t\t\tgridSize: 0,\n\t\t\toffsetX: 0,\n\t\t\toffsetY: 0,\n\t\t\t...options\n\t\t});\n\t\tthis.layers = [];\n\t}\n\n\tgetSelectionEntities(): BaseModel[] {\n\t\treturn _.flatMap(this.layers, (layer) => {\n\t\t\treturn layer.getSelectionEntities();\n\t\t});\n\t}\n\n\tgetSelectedEntities(): BaseModel[] {\n\t\treturn _.filter(this.getSelectionEntities(), (ob) => {\n\t\t\treturn ob.isSelected();\n\t\t});\n\t}\n\n\tclearSelection() {\n\t\t_.forEach(this.getSelectedEntities(), (element) => {\n\t\t\telement.setSelected(false);\n\t\t});\n\t}\n\n\tgetModels(): BaseModel[] {\n\t\treturn _.flatMap(this.layers, (layer) => {\n\t\t\treturn _.values(layer.getModels());\n\t\t});\n\t}\n\n\taddLayer(layer: LayerModel) {\n\t\tlayer.setParent(this);\n\t\tlayer.registerListener({\n\t\t\tentityRemoved: (event: BaseEntityEvent<BaseModel>): void => {}\n\t\t});\n\t\tthis.layers.push(layer);\n\t}\n\n\tremoveLayer(layer: LayerModel) {\n\t\tconst index = this.layers.indexOf(layer);\n\t\tif (index !== -1) {\n\t\t\tthis.layers.splice(index, 1);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tgetLayers() {\n\t\treturn this.layers;\n\t}\n\n\tsetGridSize(size: number = 0) {\n\t\tthis.options.gridSize = size;\n\t\tthis.fireEvent({ size: size }, 'gridUpdated');\n\t}\n\n\tgetGridPosition(pos: number) {\n\t\tif (this.options.gridSize === 0) {\n\t\t\treturn pos;\n\t\t}\n\t\treturn this.options.gridSize * Math.floor((pos + this.options.gridSize / 2) / this.options.gridSize);\n\t}\n\n\tdeserializeModel(data: ReturnType<this['serialize']>, engine: CanvasEngine) {\n\t\tconst models: {\n\t\t\t[id: string]: BaseModel;\n\t\t} = {};\n\t\tconst promises: {\n\t\t\t[id: string]: Promise<BaseModel>;\n\t\t} = {};\n\t\tconst resolvers: {\n\t\t\t[id: string]: (model: BaseModel) => any;\n\t\t} = {};\n\n\t\tconst event: DeserializeEvent = {\n\t\t\tdata: data,\n\t\t\tengine: engine,\n\t\t\tregisterModel: (model: BaseModel) => {\n\t\t\t\tmodels[model.getID()] = model;\n\t\t\t\tif (resolvers[model.getID()]) {\n\t\t\t\t\tresolvers[model.getID()](model);\n\t\t\t\t}\n\t\t\t},\n\t\t\tgetModel<T extends BaseModel>(id: string): Promise<T> {\n\t\t\t\tif (models[id]) {\n\t\t\t\t\treturn Promise.resolve(models[id]) as Promise<T>;\n\t\t\t\t}\n\t\t\t\tif (!promises[id]) {\n\t\t\t\t\tpromises[id] = new Promise((resolve) => {\n\t\t\t\t\t\tresolvers[id] = resolve;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn promises[id] as Promise<T>;\n\t\t\t}\n\t\t};\n\t\tthis.deserialize(event);\n\t}\n\n\tdeserialize(event: DeserializeEvent<this>) {\n\t\tsuper.deserialize(event);\n\t\tthis.options.offsetX = event.data.offsetX;\n\t\tthis.options.offsetY = event.data.offsetY;\n\t\tthis.options.zoom = event.data.zoom;\n\t\tthis.options.gridSize = event.data.gridSize;\n\t\t_.forEach(event.data.layers, (layer) => {\n\t\t\tconst layerOb = event.engine.getFactoryForLayer(layer.type).generateModel({\n\t\t\t\tinitialConfig: layer\n\t\t\t});\n\t\t\tlayerOb.deserialize({\n\t\t\t\t...event,\n\t\t\t\tdata: layer\n\t\t\t});\n\t\t\tthis.addLayer(layerOb);\n\t\t});\n\t}\n\n\tserialize() {\n\t\treturn {\n\t\t\t...super.serialize(),\n\t\t\toffsetX: this.options.offsetX,\n\t\t\toffsetY: this.options.offsetY,\n\t\t\tzoom: this.options.zoom,\n\t\t\tgridSize: this.options.gridSize,\n\t\t\tlayers: _.map(this.layers, (layer) => {\n\t\t\t\treturn layer.serialize();\n\t\t\t})\n\t\t};\n\t}\n\n\tsetZoomLevel(zoom: number) {\n\t\tthis.options.zoom = zoom;\n\t\tthis.fireEvent({ zoom }, 'zoomUpdated');\n\t}\n\n\tsetOffset(offsetX: number, offsetY: number) {\n\t\tthis.options.offsetX = offsetX;\n\t\tthis.options.offsetY = offsetY;\n\t\tthis.fireEvent({ offsetX, offsetY }, 'offsetUpdated');\n\t}\n\n\tsetOffsetX(offsetX: number) {\n\t\tthis.setOffset(offsetX, this.options.offsetY);\n\t}\n\n\tsetOffsetY(offsetY: number) {\n\t\tthis.setOffset(this.options.offsetX, offsetY);\n\t}\n\n\tgetOffsetY() {\n\t\treturn this.options.offsetY;\n\t}\n\n\tgetOffsetX() {\n\t\treturn this.options.offsetX;\n\t}\n\n\tgetZoomLevel() {\n\t\treturn this.options.zoom;\n\t}\n}\n","import { Toolkit } from '../Toolkit';\nimport * as _ from 'lodash';\nimport { CanvasEngine } from '../CanvasEngine';\nimport { BaseEvent, BaseListener, BaseObserver } from '../core/BaseObserver';\nimport { AbstractModelFactory } from '../core/AbstractModelFactory';\nimport { BaseModel } from './BaseModel';\n\nexport interface BaseEntityEvent<T extends BaseEntity = BaseEntity> extends BaseEvent {\n\tentity: T;\n}\n\nexport interface BaseEntityListener<T extends BaseEntity = BaseEntity> extends BaseListener {\n\tlockChanged?(event: BaseEntityEvent<T> & { locked: boolean }): void;\n}\n\nexport type BaseEntityType = 'node' | 'link' | 'port' | 'point';\n\nexport interface BaseEntityOptions {\n\tid?: string;\n\tlocked?: boolean;\n}\n\nexport type BaseEntityGenerics = {\n\tLISTENER: BaseEntityListener;\n\tOPTIONS: BaseEntityOptions;\n};\n\nexport interface DeserializeEvent<T extends BaseEntity = BaseEntity> {\n\tengine: CanvasEngine;\n\tdata: ReturnType<T['serialize']>;\n\tregisterModel(model: BaseModel);\n\tgetModel<T extends BaseModel>(id: string): Promise<T>;\n}\n\nexport class BaseEntity<T extends BaseEntityGenerics = BaseEntityGenerics> extends BaseObserver<T['LISTENER']> {\n\tprotected options: T['OPTIONS'];\n\n\tconstructor(options: T['OPTIONS'] = {}) {\n\t\tsuper();\n\t\tthis.options = {\n\t\t\tid: Toolkit.UID(),\n\t\t\t...options\n\t\t};\n\t}\n\n\tgetOptions() {\n\t\treturn this.options;\n\t}\n\n\tgetID() {\n\t\treturn this.options.id;\n\t}\n\n\tdoClone(lookupTable: { [s: string]: any } = {}, clone: any) {\n\t\t/*noop*/\n\t}\n\n\tclone(lookupTable: { [s: string]: any } = {}) {\n\t\t// try and use an existing clone first\n\t\tif (lookupTable[this.options.id]) {\n\t\t\treturn lookupTable[this.options.id];\n\t\t}\n\t\tlet clone = _.cloneDeep(this);\n\t\tclone.options = {\n\t\t\t...this.options,\n\t\t\tid: Toolkit.UID()\n\t\t};\n\t\tclone.clearListeners();\n\t\tlookupTable[this.options.id] = clone;\n\n\t\tthis.doClone(lookupTable, clone);\n\t\treturn clone;\n\t}\n\n\tclearListeners() {\n\t\tthis.listeners = {};\n\t}\n\n\tdeserialize(event: DeserializeEvent<this>) {\n\t\tthis.options.id = event.data.id;\n\t\tthis.options.locked = event.data.locked;\n\t}\n\n\tserialize() {\n\t\treturn {\n\t\t\tid: this.options.id,\n\t\t\tlocked: this.options.locked\n\t\t};\n\t}\n\n\tfireEvent<L extends Partial<BaseEntityEvent> & object>(event: L, k: keyof T['LISTENER']) {\n\t\tsuper.fireEvent(\n\t\t\t{\n\t\t\t\tentity: this,\n\t\t\t\t...event\n\t\t\t},\n\t\t\tk\n\t\t);\n\t}\n\n\tpublic isLocked(): boolean {\n\t\treturn this.options.locked;\n\t}\n\n\tpublic setLocked(locked: boolean = true) {\n\t\tthis.options.locked = locked;\n\t\tthis.fireEvent(\n\t\t\t{\n\t\t\t\tlocked: locked\n\t\t\t},\n\t\t\t'lockChanged'\n\t\t);\n\t}\n}\n","import {\n\tBaseEntity,\n\tBaseEntityEvent,\n\tBaseEntityGenerics,\n\tBaseEntityListener,\n\tBaseEntityOptions,\n\tDeserializeEvent\n} from './BaseEntity';\nimport { CanvasModel } from '../entities/canvas/CanvasModel';\n\nexport interface BaseModelListener extends BaseEntityListener {\n\tselectionChanged?(event: BaseEntityEvent<BaseModel> & { isSelected: boolean }): void;\n\n\tentityRemoved?(event: BaseEntityEvent<BaseModel>): void;\n}\n\nexport interface BaseModelOptions extends BaseEntityOptions {\n\ttype?: string;\n\tselected?: boolean;\n\textras?: any;\n}\n\nexport interface BaseModelGenerics extends BaseEntityGenerics {\n\tLISTENER: BaseModelListener;\n\tPARENT: BaseEntity;\n\tOPTIONS: BaseModelOptions;\n}\n\nexport class BaseModel<G extends BaseModelGenerics = BaseModelGenerics> extends BaseEntity<G> {\n\tprotected parent: G['PARENT'];\n\n\tconstructor(options: G['OPTIONS']) {\n\t\tsuper(options);\n\t}\n\n\tperformanceTune() {\n\t\treturn true;\n\t}\n\n\tgetParentCanvasModel(): CanvasModel {\n\t\tif (!this.parent) {\n\t\t\treturn null;\n\t\t}\n\t\tif (this.parent instanceof CanvasModel) {\n\t\t\treturn this.parent;\n\t\t} else if (this.parent instanceof BaseModel) {\n\t\t\treturn this.parent.getParentCanvasModel();\n\t\t}\n\t\treturn null;\n\t}\n\n\tgetParent(): G['PARENT'] {\n\t\treturn this.parent;\n\t}\n\n\tsetParent(parent: G['PARENT']) {\n\t\tthis.parent = parent;\n\t}\n\n\tgetSelectionEntities(): Array<BaseModel> {\n\t\treturn [this];\n\t}\n\n\tserialize() {\n\t\treturn {\n\t\t\t...super.serialize(),\n\t\t\ttype: this.options.type,\n\t\t\tselected: this.options.selected,\n\t\t\textras: this.options.extras\n\t\t};\n\t}\n\n\tdeserialize(event: DeserializeEvent<this>) {\n\t\tsuper.deserialize(event);\n\t\tthis.options.extras = event.data.extras;\n\t\tthis.options.selected = event.data.selected;\n\t}\n\n\tgetType(): string {\n\t\treturn this.options.type;\n\t}\n\n\tisSelected(): boolean {\n\t\treturn this.options.selected;\n\t}\n\n\tisLocked(): boolean {\n\t\tconst locked = super.isLocked();\n\t\tif (locked) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// delegate this call up to the parent\n\t\tif (this.parent) {\n\t\t\treturn this.parent.isLocked();\n\t\t}\n\t\treturn false;\n\t}\n\n\tsetSelected(selected: boolean = true) {\n\t\tif (this.options.selected !== selected) {\n\t\t\tthis.options.selected = selected;\n\n\t\t\tthis.fireEvent(\n\t\t\t\t{\n\t\t\t\t\tisSelected: selected\n\t\t\t\t},\n\t\t\t\t'selectionChanged'\n\t\t\t);\n\t\t}\n\t}\n\n\tremove() {\n\t\tthis.fireEvent({}, 'entityRemoved');\n\t}\n}\n","module.exports = require(\"@emotion/styled\");","import { LayerModel } from '../layer/LayerModel';\nimport { FactoryBank } from '../../core/FactoryBank';\nimport { AbstractModelFactory } from '../../core/AbstractModelFactory';\nimport { BaseModel } from '../../core-models/BaseModel';\n\nexport class SelectionLayerModel extends LayerModel {\n\tbox: ClientRect;\n\n\tconstructor() {\n\t\tsuper({\n\t\t\ttransformed: false,\n\t\t\tisSvg: false,\n\t\t\ttype: 'selection'\n\t\t});\n\t}\n\n\tsetBox(rect: ClientRect) {\n\t\tthis.box = rect;\n\t}\n\n\tgetChildModelFactoryBank(): FactoryBank<AbstractModelFactory<BaseModel>> {\n\t\t// is not used as it doesnt serialize\n\t\treturn null;\n\t}\n}\n","import { BaseEvent, BaseListener, BaseObserver } from './BaseObserver';\nimport { AbstractFactory } from './AbstractFactory';\nimport * as _ from 'lodash';\n\nexport interface FactoryBankListener<F extends AbstractFactory = AbstractFactory> extends BaseListener {\n\t/**\n\t * Factory as added to rhe bank\n\t */\n\tfactoryAdded?: (event: BaseEvent & { factory: F }) => any;\n\n\t/**\n\t * Factory was removed from the bank\n\t */\n\tfactoryRemoved?: (event: BaseEvent & { factory: F }) => any;\n}\n\n/**\n * Store and managed Factories that extend from Abstractfactory\n */\nexport class FactoryBank<\n\tF extends AbstractFactory = AbstractFactory,\n\tL extends FactoryBankListener<F> = FactoryBankListener<F>\n> extends BaseObserver<L> {\n\tprotected factories: { [type: string]: F };\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.factories = {};\n\t}\n\n\tgetFactories(): F[] {\n\t\treturn _.values(this.factories);\n\t}\n\n\tclearFactories() {\n\t\tfor (let factory in this.factories) {\n\t\t\tthis.deregisterFactory(factory);\n\t\t}\n\t}\n\n\tgetFactory<T extends F = F>(type: string): T {\n\t\tif (!this.factories[type]) {\n\t\t\tthrow new Error(`Cannot find factory with type [${type}]`);\n\t\t}\n\t\treturn this.factories[type] as T;\n\t}\n\n\tregisterFactory(factory: F) {\n\t\tfactory.setFactoryBank(this);\n\t\tthis.factories[factory.getType()] = factory;\n\t\t// todo fixme\n\t\tthis.fireEvent<'factoryAdded'>({ factory } as any, 'factoryAdded');\n\t}\n\n\tderegisterFactory(type: string) {\n\t\tconst factory = this.factories[type];\n\t\tfactory.setFactoryBank(null);\n\t\tdelete this.factories[type];\n\t\t// todo fixme\n\t\tthis.fireEvent<'factoryRemoved'>({ factory } as any, 'factoryRemoved');\n\t}\n}\n","import { Action, ActionEvent, InputType } from './Action';\nimport { KeyboardEvent, MouseEvent } from 'react';\nimport * as _ from 'lodash';\nimport { CanvasEngine } from '../CanvasEngine';\nimport { BaseModel } from '../core-models/BaseModel';\n\nexport class ActionEventBus {\n\tprotected actions: { [id: string]: Action };\n\tprotected engine: CanvasEngine;\n\tprotected keys: { [key: string]: boolean };\n\n\tconstructor(engine: CanvasEngine) {\n\t\tthis.actions = {};\n\t\tthis.engine = engine;\n\t\tthis.keys = {};\n\t}\n\n\tgetKeys(): string[] {\n\t\treturn _.keys(this.keys);\n\t}\n\n\tregisterAction(action: Action): () => void {\n\t\taction.setEngine(this.engine);\n\t\tthis.actions[action.id] = action;\n\t\treturn () => {\n\t\t\tthis.deregisterAction(action);\n\t\t};\n\t}\n\n\tderegisterAction(action: Action) {\n\t\taction.setEngine(null);\n\t\tdelete this.actions[action.id];\n\t}\n\n\tgetActionsForType(type: InputType): Action[] {\n\t\treturn _.filter(this.actions, (action) => {\n\t\t\treturn action.options.type === type;\n\t\t});\n\t}\n\n\tgetModelForEvent(actionEvent: ActionEvent<MouseEvent>): BaseModel {\n\t\tif (actionEvent.model) {\n\t\t\treturn actionEvent.model;\n\t\t}\n\t\treturn this.engine.getMouseElement(actionEvent.event);\n\t}\n\n\tgetActionsForEvent(actionEvent: ActionEvent): Action[] {\n\t\tconst { event } = actionEvent;\n\t\tif (event.type === 'mousedown') {\n\t\t\treturn this.getActionsForType(InputType.MOUSE_DOWN);\n\t\t} else if (event.type === 'mouseup') {\n\t\t\treturn this.getActionsForType(InputType.MOUSE_UP);\n\t\t} else if (event.type === 'keydown') {\n\t\t\t// store the recorded key\n\t\t\tthis.keys[(event as KeyboardEvent).key.toLowerCase()] = true;\n\t\t\treturn this.getActionsForType(InputType.KEY_DOWN);\n\t\t} else if (event.type === 'keyup') {\n\t\t\t// delete the recorded key\n\t\t\tdelete this.keys[(event as KeyboardEvent).key.toLowerCase()];\n\t\t\treturn this.getActionsForType(InputType.KEY_UP);\n\t\t} else if (event.type === 'mousemove') {\n\t\t\treturn this.getActionsForType(InputType.MOUSE_MOVE);\n\t\t} else if (event.type === 'wheel') {\n\t\t\treturn this.getActionsForType(InputType.MOUSE_WHEEL);\n\t\t}\n\t\treturn [];\n\t}\n\n\tfireAction(actionEvent: ActionEvent) {\n\t\tconst actions = this.getActionsForEvent(actionEvent);\n\t\tfor (let action of actions) {\n\t\t\taction.options.fire(actionEvent as any);\n\t\t}\n\t}\n}\n","import { WheelEvent } from 'react';\nimport { Action, ActionEvent, InputType } from '../core-actions/Action';\n\nexport interface ZoomCanvasActionOptions {\n\tinverseZoom?: boolean;\n}\n\nexport class ZoomCanvasAction extends Action {\n\tconstructor(options: ZoomCanvasActionOptions = {}) {\n\t\tsuper({\n\t\t\ttype: InputType.MOUSE_WHEEL,\n\t\t\tfire: (actionEvent: ActionEvent<WheelEvent>) => {\n\t\t\t\tconst { event } = actionEvent;\n\t\t\t\t// we can block layer rendering because we are only targeting the transforms\n\t\t\t\tfor (let layer of this.engine.getModel().getLayers()) {\n\t\t\t\t\tlayer.allowRepaint(false);\n\t\t\t\t}\n\n\t\t\t\tconst model = this.engine.getModel();\n\t\t\t\tevent.stopPropagation();\n\t\t\t\tconst oldZoomFactor = this.engine.getModel().getZoomLevel() / 100;\n\t\t\t\tlet scrollDelta = options.inverseZoom ? -event.deltaY : event.deltaY;\n\t\t\t\t//check if it is pinch gesture\n\t\t\t\tif (event.ctrlKey && scrollDelta % 1 !== 0) {\n\t\t\t\t\t/*\n\t\t\t\t\t\tChrome and Firefox sends wheel event with deltaY that\n\t\t\t\t\t\thave fractional part, also `ctrlKey` prop of the event is true\n\t\t\t\t\t\tthough ctrl isn't pressed\n\t\t\t\t\t*/\n\t\t\t\t\tscrollDelta /= 3;\n\t\t\t\t} else {\n\t\t\t\t\tscrollDelta /= 60;\n\t\t\t\t}\n\t\t\t\tif (model.getZoomLevel() + scrollDelta > 10) {\n\t\t\t\t\tmodel.setZoomLevel(model.getZoomLevel() + scrollDelta);\n\t\t\t\t}\n\n\t\t\t\tconst zoomFactor = model.getZoomLevel() / 100;\n\n\t\t\t\tconst boundingRect = event.currentTarget.getBoundingClientRect();\n\t\t\t\tconst clientWidth = boundingRect.width;\n\t\t\t\tconst clientHeight = boundingRect.height;\n\t\t\t\t// compute difference between rect before and after scroll\n\t\t\t\tconst widthDiff = clientWidth * zoomFactor - clientWidth * oldZoomFactor;\n\t\t\t\tconst heightDiff = clientHeight * zoomFactor - clientHeight * oldZoomFactor;\n\t\t\t\t// compute mouse coords relative to canvas\n\t\t\t\tconst clientX = event.clientX - boundingRect.left;\n\t\t\t\tconst clientY = event.clientY - boundingRect.top;\n\n\t\t\t\t// compute width and height increment factor\n\t\t\t\tconst xFactor = (clientX - model.getOffsetX()) / oldZoomFactor / clientWidth;\n\t\t\t\tconst yFactor = (clientY - model.getOffsetY()) / oldZoomFactor / clientHeight;\n\n\t\t\t\tmodel.setOffset(model.getOffsetX() - widthDiff * xFactor, model.getOffsetY() - heightDiff * yFactor);\n\t\t\t\tthis.engine.repaintCanvas();\n\n\t\t\t\t// re-enable rendering\n\t\t\t\tfor (let layer of this.engine.getModel().getLayers()) {\n\t\t\t\t\tlayer.allowRepaint(true);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n}\n","import { Action, ActionEvent, InputType } from '../core-actions/Action';\nimport { KeyboardEvent } from 'react';\nimport * as _ from 'lodash';\n\nexport interface DeleteItemsActionOptions {\n\tkeyCodes?: number[];\n\tmodifiers?: {\n\t\tctrlKey?: boolean;\n\t\tshiftKey?: boolean;\n\t\taltKey?: boolean;\n\t\tmetaKey?: boolean;\n\t};\n}\n\n/**\n * Deletes all selected items\n */\nexport class DeleteItemsAction extends Action {\n\tconstructor(options: DeleteItemsActionOptions = {}) {\n\t\tconst keyCodes = options.keyCodes || [46, 8];\n\t\tconst modifiers = {\n\t\t\tctrlKey: false,\n\t\t\tshiftKey: false,\n\t\t\taltKey: false,\n\t\t\tmetaKey: false,\n\t\t\t...options.modifiers\n\t\t};\n\n\t\tsuper({\n\t\t\ttype: InputType.KEY_DOWN,\n\t\t\tfire: (event: ActionEvent<KeyboardEvent>) => {\n\t\t\t\tconst { keyCode, ctrlKey, shiftKey, altKey, metaKey } = event.event;\n\n\t\t\t\tif (keyCodes.indexOf(keyCode) !== -1 && _.isEqual({ ctrlKey, shiftKey, altKey, metaKey }, modifiers)) {\n\t\t\t\t\t_.forEach(this.engine.getModel().getSelectedEntities(), (model) => {\n\t\t\t\t\t\t// only delete items which are not locked\n\t\t\t\t\t\tif (!model.isLocked()) {\n\t\t\t\t\t\t\tmodel.remove();\n\t\t\t\t\t\t\tthis.engine.getModel().fireEvent({ model }, 'itemRemoved');\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tthis.engine.repaintCanvas();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n}\n","import { State } from './State';\nimport * as _ from 'lodash';\nimport { CanvasEngine } from '../CanvasEngine';\nimport { BaseEvent, BaseListener, BaseObserver } from '../core/BaseObserver';\n\nexport interface StateMachineListener extends BaseListener {\n\tstateChanged?: (event: BaseEvent & { newState: State }) => any;\n}\n\nexport class StateMachine extends BaseObserver<StateMachineListener> {\n\tprotected currentState: State;\n\tprotected stateStack: State[];\n\tprotected engine: CanvasEngine;\n\n\tconstructor(engine: CanvasEngine) {\n\t\tsuper();\n\t\tthis.engine = engine;\n\t\tthis.stateStack = [];\n\t}\n\n\tgetCurrentState() {\n\t\treturn this.currentState;\n\t}\n\n\tpushState(state: State) {\n\t\tthis.stateStack.push(state);\n\t\tthis.setState(state);\n\t}\n\n\tpopState() {\n\t\tthis.stateStack.pop();\n\t\tthis.setState(_.last(this.stateStack));\n\t}\n\n\tsetState(state: State) {\n\t\tstate.setEngine(this.engine);\n\n\t\t// if no state object, get the initial state\n\t\tif (this.currentState) {\n\t\t\tthis.currentState.deactivated(state);\n\t\t}\n\t\tconst old = this.currentState;\n\t\tthis.currentState = state;\n\t\tif (this.currentState) {\n\t\t\tthis.currentState.activated(old);\n\t\t\tthis.fireEvent<'stateChanged'>(\n\t\t\t\t{\n\t\t\t\t\tnewState: state\n\t\t\t\t},\n\t\t\t\t'stateChanged'\n\t\t\t);\n\t\t}\n\t}\n}\n","import { CanvasEngine } from '../CanvasEngine';\nimport { FactoryBank } from './FactoryBank';\n\n/**\n * Base factory for all the different types of entities.\n * Gets registered with the engine, and is used to generate models\n */\nexport abstract class AbstractFactory<E extends CanvasEngine = CanvasEngine> {\n\t/**\n\t * Couples the factory with the models it generates\n\t */\n\tprotected type: string;\n\t/**\n\t * The engine gets injected when the factory is registered\n\t */\n\tprotected engine: E;\n\tprotected bank: FactoryBank;\n\n\tconstructor(type: string) {\n\t\tthis.type = type;\n\t}\n\n\tsetDiagramEngine(engine: E) {\n\t\tthis.engine = engine;\n\t}\n\n\tsetFactoryBank(bank: FactoryBank) {\n\t\tthis.bank = bank;\n\t}\n\n\tgetType(): string {\n\t\treturn this.type;\n\t}\n}\n","import { AbstractFactory } from './AbstractFactory';\nimport { BaseModel } from '../core-models/BaseModel';\nimport { CanvasEngine } from '../CanvasEngine';\n\nexport interface GenerateModelEvent {\n\tinitialConfig?: any;\n}\n\nexport abstract class AbstractModelFactory<\n\tT extends BaseModel = BaseModel,\n\tE extends CanvasEngine = CanvasEngine\n> extends AbstractFactory<E> {\n\t/**\n\t * Generates new models (the core factory pattern)\n\t */\n\tabstract generateModel(event: GenerateModelEvent): T;\n}\n","import { BaseModel } from '../core-models/BaseModel';\nimport { AbstractModelFactory } from './AbstractModelFactory';\nimport { CanvasEngine } from '../CanvasEngine';\n\nexport interface GenerateWidgetEvent<T extends BaseModel> {\n\tmodel: T;\n}\n\n/**\n * Further extends the AbstractFactory to add widget generation capability.\n */\nexport abstract class AbstractReactFactory<\n\tT extends BaseModel = BaseModel,\n\tE extends CanvasEngine = CanvasEngine\n> extends AbstractModelFactory<T, E> {\n\t/**\n\t * Generates React widgets from the model contained in the event object\n\t */\n\tabstract generateReactWidget(event: GenerateWidgetEvent<T>): JSX.Element;\n}\n","import { BaseModel, BaseModelGenerics, BaseModelListener, BaseModelOptions } from './BaseModel';\nimport { BaseEntityEvent, DeserializeEvent } from './BaseEntity';\nimport { Point, Rectangle } from '@projectstorm/geometry';\nimport { ModelGeometryInterface } from '../core/ModelGeometryInterface';\n\nexport interface BasePositionModelListener extends BaseModelListener {\n\tpositionChanged?(event: BaseEntityEvent<BasePositionModel>): void;\n}\n\nexport interface BasePositionModelOptions extends BaseModelOptions {\n\tposition?: Point;\n}\n\nexport interface BasePositionModelGenerics extends BaseModelGenerics {\n\tLISTENER: BasePositionModelListener;\n\tOPTIONS: BasePositionModelOptions;\n}\n\nexport class BasePositionModel<G extends BasePositionModelGenerics = BasePositionModelGenerics> extends BaseModel<G>\n\timplements ModelGeometryInterface {\n\tprotected position: Point;\n\n\tconstructor(options: G['OPTIONS']) {\n\t\tsuper(options);\n\t\tthis.position = options.position || new Point(0, 0);\n\t}\n\n\tsetPosition(point: Point);\n\tsetPosition(x: number, y: number);\n\tsetPosition(x, y?) {\n\t\tif (typeof x === 'object') {\n\t\t\tthis.position = x;\n\t\t} else if (typeof x) {\n\t\t\tthis.position = new Point(x, y);\n\t\t}\n\t\tthis.fireEvent({}, 'positionChanged');\n\t}\n\n\tgetBoundingBox(): Rectangle {\n\t\treturn new Rectangle(this.position, 0, 0);\n\t}\n\n\tdeserialize(event: DeserializeEvent<this>) {\n\t\tsuper.deserialize(event);\n\t\tthis.position = new Point(event.data.x, event.data.y);\n\t}\n\n\tserialize() {\n\t\treturn {\n\t\t\t...super.serialize(),\n\t\t\tx: this.position.x,\n\t\t\ty: this.position.y\n\t\t};\n\t}\n\n\tgetPosition(): Point {\n\t\treturn this.position;\n\t}\n\n\tgetX() {\n\t\treturn this.position.x;\n\t}\n\n\tgetY() {\n\t\treturn this.position.y;\n\t}\n}\n","import * as React from 'react';\nimport styled from '@emotion/styled';\nimport { css } from '@emotion/core';\nimport { CSSProperties } from 'react';\nimport { LayerModel } from './LayerModel';\n\nexport interface TransformLayerWidgetProps {\n\tlayer: LayerModel;\n}\n\nnamespace S {\n\tconst shared = css`\n\t\ttop: 0;\n\t\tleft: 0;\n\t\tright: 0;\n\t\tbottom: 0;\n\t\tposition: absolute;\n\t\tpointer-events: none;\n\t\ttransform-origin: 0 0;\n\t\twidth: 100%;\n\t\theight: 100%;\n\t\toverflow: visible;\n\t`;\n\n\texport const DivLayer = styled.div`\n\t\t${shared}\n\t`;\n\n\texport const SvgLayer = styled.svg`\n\t\t${shared}\n\t`;\n}\n\nexport class TransformLayerWidget extends React.Component<TransformLayerWidgetProps> {\n\tconstructor(props: TransformLayerWidgetProps) {\n\t\tsuper(props);\n\t\tthis.state = {};\n\t}\n\n\tgetTransform() {\n\t\tconst model = this.props.layer.getParent();\n\t\treturn `\n\t\t\ttranslate(\n\t\t\t\t${model.getOffsetX()}px,\n\t\t\t\t${model.getOffsetY()}px)\n\t\t\tscale(\n\t\t\t\t${model.getZoomLevel() / 100.0}\n\t\t\t)\n  \t`;\n\t}\n\n\tgetTransformStyle(): CSSProperties {\n\t\tif (this.props.layer.getOptions().transformed) {\n\t\t\treturn {\n\t\t\t\ttransform: this.getTransform()\n\t\t\t};\n\t\t}\n\t\treturn {};\n\t}\n\n\trender() {\n\t\tif (this.props.layer.getOptions().isSvg) {\n\t\t\treturn <S.SvgLayer style={this.getTransformStyle()}>{this.props.children}</S.SvgLayer>;\n\t\t}\n\t\treturn <S.DivLayer style={this.getTransformStyle()}>{this.props.children}</S.DivLayer>;\n\t}\n}\n","import * as React from 'react';\nimport { LayerModel } from './LayerModel';\nimport { CanvasEngine } from '../../CanvasEngine';\n\nexport interface SmartLayerWidgetProps {\n\tlayer: LayerModel;\n\tengine: CanvasEngine;\n}\n\nexport class SmartLayerWidget extends React.Component<SmartLayerWidgetProps> {\n\tshouldComponentUpdate(): boolean {\n\t\treturn this.props.layer.isRepaintEnabled();\n\t}\n\n\trender() {\n\t\treturn this.props.engine.getFactoryForLayer(this.props.layer).generateReactWidget({ model: this.props.layer });\n\t}\n}\n","import { BaseModel, BaseModelGenerics, BaseModelOptions } from '../../core-models/BaseModel';\nimport { CanvasModel } from '../canvas/CanvasModel';\nimport * as _ from 'lodash';\nimport { CanvasEngine } from '../../CanvasEngine';\nimport { FactoryBank } from '../../core/FactoryBank';\nimport { AbstractModelFactory } from '../../core/AbstractModelFactory';\nimport { DeserializeEvent } from '../../core-models/BaseEntity';\n\nexport interface LayerModelOptions extends BaseModelOptions {\n\tisSvg?: boolean;\n\ttransformed?: boolean;\n}\n\nexport interface LayerModelGenerics extends BaseModelGenerics {\n\tOPTIONS: LayerModelOptions;\n\tPARENT: CanvasModel;\n\tCHILDREN: BaseModel;\n\tENGINE: CanvasEngine;\n}\n\nexport abstract class LayerModel<G extends LayerModelGenerics = LayerModelGenerics> extends BaseModel<G> {\n\tprotected models: { [id: string]: G['CHILDREN'] };\n\tprotected repaintEnabled: boolean;\n\n\tconstructor(options: G['OPTIONS'] = {}) {\n\t\tsuper(options);\n\t\tthis.models = {};\n\t\tthis.repaintEnabled = true;\n\t}\n\n\t/**\n\t * This is used for deserialization\n\t */\n\tabstract getChildModelFactoryBank(engine: G['ENGINE']): FactoryBank<AbstractModelFactory<BaseModel>>;\n\n\tdeserialize(event: DeserializeEvent<this>) {\n\t\tsuper.deserialize(event);\n\t\tthis.options.isSvg = !!event.data.isSvg;\n\t\tthis.options.transformed = !!event.data.transformed;\n\t\t_.forEach(event.data.models, (model) => {\n\t\t\tconst modelOb = this.getChildModelFactoryBank(event.engine).getFactory(model.type).generateModel({\n\t\t\t\tinitialConfig: model\n\t\t\t});\n\t\t\tmodelOb.deserialize({\n\t\t\t\t...event,\n\t\t\t\tdata: model\n\t\t\t});\n\t\t\tthis.addModel(modelOb);\n\t\t});\n\t}\n\n\tserialize() {\n\t\treturn {\n\t\t\t...super.serialize(),\n\t\t\tisSvg: this.options.isSvg,\n\t\t\ttransformed: this.options.transformed,\n\t\t\tmodels: _.mapValues(this.models, (model) => {\n\t\t\t\treturn model.serialize();\n\t\t\t})\n\t\t};\n\t}\n\n\tisRepaintEnabled() {\n\t\treturn this.repaintEnabled;\n\t}\n\n\tallowRepaint(allow: boolean = true) {\n\t\tthis.repaintEnabled = allow;\n\t}\n\n\tremove() {\n\t\tif (this.parent) {\n\t\t\tthis.parent.removeLayer(this);\n\t\t}\n\t\tsuper.remove();\n\t}\n\n\taddModel(model: G['CHILDREN']) {\n\t\tmodel.setParent(this);\n\t\tthis.models[model.getID()] = model;\n\t}\n\n\tgetSelectionEntities(): Array<BaseModel> {\n\t\treturn _.flatMap(this.models, (model) => {\n\t\t\treturn model.getSelectionEntities();\n\t\t});\n\t}\n\n\tgetModels() {\n\t\treturn this.models;\n\t}\n\n\tgetModel(id: string) {\n\t\treturn this.models[id];\n\t}\n\n\tremoveModel(id: string | G['CHILDREN']): boolean {\n\t\tconst _id = typeof id === 'string' ? id : id.getID();\n\t\tif (this.models[_id]) {\n\t\t\tdelete this.models[_id];\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n}\n","import * as React from 'react';\nimport styled from '@emotion/styled';\n\nexport interface SelectionBoxWidgetProps {\n\trect: ClientRect;\n}\n\nnamespace S {\n\texport const Container = styled.div`\n\t\tposition: absolute;\n\t\tbackground-color: rgba(0, 192, 255, 0.2);\n\t\tborder: solid 2px rgb(0, 192, 255);\n\t`;\n}\n\nexport class SelectionBoxWidget extends React.Component<SelectionBoxWidgetProps> {\n\trender() {\n\t\tconst { rect } = this.props;\n\t\treturn (\n\t\t\t<S.Container\n\t\t\t\tstyle={{\n\t\t\t\t\ttop: rect.top,\n\t\t\t\t\tleft: rect.left,\n\t\t\t\t\twidth: rect.width,\n\t\t\t\t\theight: rect.height\n\t\t\t\t}}\n\t\t\t/>\n\t\t);\n\t}\n}\n","import { AbstractDisplacementState, AbstractDisplacementStateEvent } from '../core-state/AbstractDisplacementState';\nimport { State } from '../core-state/State';\n\nexport interface DragCanvasStateOptions {\n\t/**\n\t * If enabled, the canvas is available to drag\n\t */\n\tallowDrag?: boolean;\n}\n\nexport class DragCanvasState extends AbstractDisplacementState {\n\t// store this as we drag the canvas\n\tinitialCanvasX: number;\n\tinitialCanvasY: number;\n\tconfig: DragCanvasStateOptions;\n\n\tconstructor(options: DragCanvasStateOptions = {}) {\n\t\tsuper({\n\t\t\tname: 'drag-canvas'\n\t\t});\n\t\tthis.config = {\n\t\t\tallowDrag: true,\n\t\t\t...options\n\t\t};\n\t}\n\n\tasync activated(prev) {\n\t\tsuper.activated(prev);\n\t\tthis.engine.getModel().clearSelection();\n\t\tawait this.engine.repaintCanvas(true);\n\n\t\t// we can block layer rendering because we are only targeting the transforms\n\t\tfor (let layer of this.engine.getModel().getLayers()) {\n\t\t\tlayer.allowRepaint(false);\n\t\t}\n\n\t\tthis.initialCanvasX = this.engine.getModel().getOffsetX();\n\t\tthis.initialCanvasY = this.engine.getModel().getOffsetY();\n\t}\n\n\tdeactivated(next: State) {\n\t\tsuper.deactivated(next);\n\t\tfor (let layer of this.engine.getModel().getLayers()) {\n\t\t\tlayer.allowRepaint(true);\n\t\t}\n\t}\n\n\tfireMouseMoved(event: AbstractDisplacementStateEvent) {\n\t\tif (this.config.allowDrag) {\n\t\t\tthis.engine\n\t\t\t\t.getModel()\n\t\t\t\t.setOffset(this.initialCanvasX + event.displacementX, this.initialCanvasY + event.displacementY);\n\t\t\tthis.engine.repaintCanvas();\n\t\t}\n\t}\n}\n","import { State } from '../core-state/State';\nimport { Action, ActionEvent, InputType } from '../core-actions/Action';\nimport { SelectionBoxState } from './SelectionBoxState';\nimport { MouseEvent } from 'react';\n\nexport class SelectingState extends State {\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'selecting'\n\t\t});\n\t\tthis.keys = ['shift'];\n\n\t\tthis.registerAction(\n\t\t\tnew Action({\n\t\t\t\ttype: InputType.MOUSE_DOWN,\n\t\t\t\tfire: (event: ActionEvent<MouseEvent>) => {\n\t\t\t\t\tconst element = this.engine.getActionEventBus().getModelForEvent(event);\n\n\t\t\t\t\t// go into a selection box on the canvas state\n\t\t\t\t\tif (!element) {\n\t\t\t\t\t\tthis.transitionWithEvent(new SelectionBoxState(), event);\n\t\t\t\t\t} else {\n\t\t\t\t\t\telement.setSelected(true);\n\t\t\t\t\t\tthis.engine.repaintCanvas();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t}\n}\n","import { AbstractDisplacementState, AbstractDisplacementStateEvent } from '../core-state/AbstractDisplacementState';\nimport { State } from '../core-state/State';\nimport { SelectionLayerModel } from '../entities/selection/SelectionLayerModel';\nimport { Rectangle } from '@projectstorm/geometry';\nimport { ModelGeometryInterface } from '../core/ModelGeometryInterface';\n\nexport class SelectionBoxState extends AbstractDisplacementState {\n\tlayer: SelectionLayerModel;\n\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'selection-box'\n\t\t});\n\t}\n\n\tactivated(previous: State) {\n\t\tsuper.activated(previous);\n\t\tthis.layer = new SelectionLayerModel();\n\t\tthis.engine.getModel().addLayer(this.layer);\n\t}\n\n\tdeactivated(next: State) {\n\t\tsuper.deactivated(next);\n\t\tthis.layer.remove();\n\t\tthis.engine.repaintCanvas();\n\t}\n\n\tgetBoxDimensions(event: AbstractDisplacementStateEvent): ClientRect {\n\t\tconst rel = this.engine.getRelativePoint(event.event.clientX, event.event.clientY);\n\n\t\treturn {\n\t\t\tleft: rel.x > this.initialXRelative ? this.initialXRelative : rel.x,\n\t\t\ttop: rel.y > this.initialYRelative ? this.initialYRelative : rel.y,\n\t\t\twidth: Math.abs(rel.x - this.initialXRelative),\n\t\t\theight: Math.abs(rel.y - this.initialYRelative),\n\t\t\tright: rel.x < this.initialXRelative ? this.initialXRelative : rel.x,\n\t\t\tbottom: rel.y < this.initialYRelative ? this.initialYRelative : rel.y\n\t\t};\n\t}\n\n\tfireMouseMoved(event: AbstractDisplacementStateEvent) {\n\t\tthis.layer.setBox(this.getBoxDimensions(event));\n\n\t\tconst relative = this.engine.getRelativeMousePoint({\n\t\t\tclientX: this.initialX,\n\t\t\tclientY: this.initialY\n\t\t});\n\t\tif (event.virtualDisplacementX < 0) {\n\t\t\trelative.x -= Math.abs(event.virtualDisplacementX);\n\t\t}\n\t\tif (event.virtualDisplacementY < 0) {\n\t\t\trelative.y -= Math.abs(event.virtualDisplacementY);\n\t\t}\n\t\tconst rect = new Rectangle(relative, Math.abs(event.virtualDisplacementX), Math.abs(event.virtualDisplacementY));\n\n\t\tfor (let model of this.engine.getModel().getSelectionEntities()) {\n\t\t\tif (((model as unknown) as ModelGeometryInterface).getBoundingBox) {\n\t\t\t\tconst bounds = ((model as unknown) as ModelGeometryInterface).getBoundingBox();\n\t\t\t\tif (rect.containsPoint(bounds.getTopLeft()) && rect.containsPoint(bounds.getBottomRight())) {\n\t\t\t\t\tmodel.setSelected(true);\n\t\t\t\t} else {\n\t\t\t\t\tmodel.setSelected(false);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.engine.repaintCanvas();\n\t}\n}\n","import { AbstractDisplacementState, AbstractDisplacementStateEvent } from '../core-state/AbstractDisplacementState';\nimport { State } from '../core-state/State';\nimport { Action, ActionEvent, InputType } from '../core-actions/Action';\nimport { BasePositionModel } from '../core-models/BasePositionModel';\nimport { Point } from '@projectstorm/geometry';\nimport { BaseModel } from '../core-models/BaseModel';\nimport { CanvasEngine } from '../CanvasEngine';\n\nexport class MoveItemsState<E extends CanvasEngine = CanvasEngine> extends AbstractDisplacementState<E> {\n\tinitialPositions: {\n\t\t[id: string]: {\n\t\t\tpoint: Point;\n\t\t\titem: BaseModel;\n\t\t};\n\t};\n\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'move-items'\n\t\t});\n\t\tthis.registerAction(\n\t\t\tnew Action({\n\t\t\t\ttype: InputType.MOUSE_DOWN,\n\t\t\t\tfire: (event: ActionEvent<React.MouseEvent>) => {\n\t\t\t\t\tconst element = this.engine.getActionEventBus().getModelForEvent(event);\n\t\t\t\t\tif (!element) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (!element.isSelected()) {\n\t\t\t\t\t\tthis.engine.getModel().clearSelection();\n\t\t\t\t\t}\n\t\t\t\t\telement.setSelected(true);\n\t\t\t\t\tthis.engine.repaintCanvas();\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t}\n\n\tactivated(previous: State) {\n\t\tsuper.activated(previous);\n\t\tthis.initialPositions = {};\n\t}\n\n\tfireMouseMoved(event: AbstractDisplacementStateEvent) {\n\t\tconst items = this.engine.getModel().getSelectedEntities();\n\t\tconst model = this.engine.getModel();\n\t\tfor (let item of items) {\n\t\t\tif (item instanceof BasePositionModel) {\n\t\t\t\tif (item.isLocked()) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif (!this.initialPositions[item.getID()]) {\n\t\t\t\t\tthis.initialPositions[item.getID()] = {\n\t\t\t\t\t\tpoint: item.getPosition(),\n\t\t\t\t\t\titem: item\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tconst pos = this.initialPositions[item.getID()].point;\n\t\t\t\titem.setPosition(\n\t\t\t\t\tmodel.getGridPosition(pos.x + event.virtualDisplacementX),\n\t\t\t\t\tmodel.getGridPosition(pos.y + event.virtualDisplacementY)\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\tthis.engine.repaintCanvas();\n\t}\n}\n","export * from './CanvasEngine';\nexport * from './Toolkit';\nexport * from './entities/canvas/CanvasModel';\n\nexport * from './core/AbstractFactory';\nexport * from './core/AbstractModelFactory';\nexport * from './core/AbstractReactFactory';\nexport * from './core/BaseObserver';\nexport * from './core/FactoryBank';\nexport * from './core/ModelGeometryInterface';\n\nexport * from './core-actions/Action';\nexport * from './core-actions/ActionEventBus';\n\nexport * from './core-models/BaseEntity';\nexport * from './core-models/BaseModel';\nexport * from './core-models/BasePositionModel';\n\nexport * from './entities/canvas/CanvasModel';\nexport * from './entities/canvas/CanvasWidget';\n\nexport * from './entities/layer/LayerModel';\nexport * from './entities/layer/TransformLayerWidget';\nexport * from './entities/layer/SmartLayerWidget';\n\nexport * from './entities/selection/SelectionBoxLayerFactory';\nexport * from './entities/selection/SelectionBoxWidget';\nexport * from './entities/selection/SelectionLayerModel';\n\nexport * from './widgets/PeformanceWidget';\n\nexport * from './core-state/AbstractDisplacementState';\nexport * from './core-state/State';\nexport * from './core-state/StateMachine';\n\nexport * from './states/DefaultState';\nexport * from './states/DragCanvasState';\nexport * from './states/SelectingState';\nexport * from './states/SelectionBoxState';\nexport * from './states/MoveItemsState';\n\nexport * from './actions/DeleteItemsAction';\nexport * from './actions/ZoomCanvasAction';\n","import { debounce } from 'lodash';\nimport { CanvasModel } from './entities/canvas/CanvasModel';\nimport { FactoryBank } from './core/FactoryBank';\nimport { AbstractReactFactory } from './core/AbstractReactFactory';\nimport { LayerModel } from './entities/layer/LayerModel';\nimport { BaseListener, BaseObserver } from './core/BaseObserver';\nimport { MouseEvent } from 'react';\nimport { BaseModel } from './core-models/BaseModel';\nimport { Point } from '@projectstorm/geometry';\nimport { ActionEventBus } from './core-actions/ActionEventBus';\nimport { ZoomCanvasAction } from './actions/ZoomCanvasAction';\nimport { DeleteItemsAction } from './actions/DeleteItemsAction';\nimport { StateMachine } from './core-state/StateMachine';\n\nexport interface CanvasEngineListener extends BaseListener {\n\tcanvasReady?(): void;\n\n\trepaintCanvas?(): void;\n\n\trendered?(): void;\n}\n\n/**\n * Defines the CanvasEngine options\n */\nexport interface CanvasEngineOptions {\n\tregisterDefaultDeleteItemsAction?: boolean;\n\tregisterDefaultZoomCanvasAction?: boolean;\n\t/**\n\t * Defines the debounce wait time in milliseconds if > 0\n\t */\n\trepaintDebounceMs?: number;\n}\n\nexport class CanvasEngine<\n\tL extends CanvasEngineListener = CanvasEngineListener,\n\tM extends CanvasModel = CanvasModel\n> extends BaseObserver<L> {\n\tprotected model: M;\n\tprotected layerFactories: FactoryBank<AbstractReactFactory<LayerModel>>;\n\tprotected canvas: HTMLDivElement;\n\tprotected eventBus: ActionEventBus;\n\tprotected stateMachine: StateMachine;\n\tprotected options: CanvasEngineOptions;\n\n\tconstructor(options: CanvasEngineOptions = {}) {\n\t\tsuper();\n\t\tthis.model = null;\n\t\tthis.eventBus = new ActionEventBus(this);\n\t\tthis.stateMachine = new StateMachine(this);\n\t\tthis.layerFactories = new FactoryBank();\n\t\tthis.registerFactoryBank(this.layerFactories);\n\n\t\t/**\n\t\t * Overrides the standard options with the possible given options\n\t\t */\n\t\tthis.options = {\n\t\t\tregisterDefaultDeleteItemsAction: true,\n\t\t\tregisterDefaultZoomCanvasAction: true,\n\t\t\trepaintDebounceMs: 0,\n\t\t\t...options\n\t\t};\n\t\tif (this.options.registerDefaultZoomCanvasAction === true) {\n\t\t\tthis.eventBus.registerAction(new ZoomCanvasAction());\n\t\t}\n\t\tif (this.options.registerDefaultDeleteItemsAction === true) {\n\t\t\tthis.eventBus.registerAction(new DeleteItemsAction());\n\t\t}\n\t}\n\n\tgetStateMachine() {\n\t\treturn this.stateMachine;\n\t}\n\n\tgetRelativeMousePoint(event: { clientX: number; clientY: number }): Point {\n\t\tconst point = this.getRelativePoint(event.clientX, event.clientY);\n\t\treturn new Point(\n\t\t\t(point.x - this.model.getOffsetX()) / (this.model.getZoomLevel() / 100.0),\n\t\t\t(point.y - this.model.getOffsetY()) / (this.model.getZoomLevel() / 100.0)\n\t\t);\n\t}\n\n\tgetRelativePoint(x, y): Point {\n\t\tconst canvasRect = this.canvas.getBoundingClientRect();\n\t\treturn new Point(x - canvasRect.left, y - canvasRect.top);\n\t}\n\n\tregisterFactoryBank(factory: FactoryBank) {\n\t\tfactory.registerListener({\n\t\t\tfactoryAdded: (event) => {\n\t\t\t\tevent.factory.setDiagramEngine(this);\n\t\t\t},\n\t\t\tfactoryRemoved: (event) => {\n\t\t\t\tevent.factory.setDiagramEngine(null);\n\t\t\t}\n\t\t});\n\t}\n\n\tgetActionEventBus() {\n\t\treturn this.eventBus;\n\t}\n\n\tgetLayerFactories() {\n\t\treturn this.layerFactories;\n\t}\n\n\tgetFactoryForLayer<F extends AbstractReactFactory<LayerModel>>(layer: LayerModel | string) {\n\t\tif (typeof layer === 'string') {\n\t\t\treturn this.layerFactories.getFactory(layer);\n\t\t}\n\t\treturn this.layerFactories.getFactory(layer.getType());\n\t}\n\n\tsetModel(model: M) {\n\t\tthis.model = model;\n\t\tif (this.canvas) {\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tthis.repaintCanvas();\n\t\t\t});\n\t\t}\n\t}\n\n\tgetModel(): M {\n\t\treturn this.model;\n\t}\n\n\trepaintCanvas(promise: true): Promise<any>;\n\trepaintCanvas(): void;\n\trepaintCanvas(promise?): Promise<any> | void {\n\t\tconst { repaintDebounceMs } = this.options;\n\n\t\t/**\n\t\t * The actual repaint function\n\t\t */\n\t\tconst repaint = () => {\n\t\t\tthis.iterateListeners((listener) => {\n\t\t\t\tif (listener.repaintCanvas) {\n\t\t\t\t\tlistener.repaintCanvas();\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\n\t\t// if the `repaintDebounceMs` option is > 0, then apply the debounce\n\t\tlet repaintFn = repaint;\n\n\t\tif (repaintDebounceMs > 0) {\n\t\t\trepaintFn = debounce(repaint, repaintDebounceMs);\n\t\t}\n\n\t\tif (promise) {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tconst l = this.registerListener({\n\t\t\t\t\trendered: () => {\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t\tl.deregister();\n\t\t\t\t\t}\n\t\t\t\t} as L);\n\t\t\t\trepaintFn();\n\t\t\t});\n\t\t}\n\n\t\trepaintFn();\n\t}\n\n\tsetCanvas(canvas?: HTMLDivElement) {\n\t\tif (this.canvas !== canvas) {\n\t\t\tthis.canvas = canvas;\n\t\t\tif (canvas) {\n\t\t\t\tthis.fireEvent({}, 'canvasReady');\n\t\t\t}\n\t\t}\n\t}\n\n\tgetCanvas() {\n\t\treturn this.canvas;\n\t}\n\n\tgetMouseElement(event: MouseEvent): BaseModel {\n\t\treturn null;\n\t}\n\n\tzoomToFit() {\n\t\tconst xFactor = this.canvas.clientWidth / this.canvas.scrollWidth;\n\t\tconst yFactor = this.canvas.clientHeight / this.canvas.scrollHeight;\n\t\tconst zoomFactor = xFactor < yFactor ? xFactor : yFactor;\n\n\t\tthis.model.setZoomLevel(this.model.getZoomLevel() * zoomFactor);\n\t\tthis.model.setOffset(0, 0);\n\t\tthis.repaintCanvas();\n\t}\n}\n","module.exports = require(\"closest\");","import * as React from 'react';\nimport { CanvasEngine } from '../../CanvasEngine';\nimport { TransformLayerWidget } from '../layer/TransformLayerWidget';\nimport styled from '@emotion/styled';\nimport { SmartLayerWidget } from '../layer/SmartLayerWidget';\n\nexport interface DiagramProps {\n\tengine: CanvasEngine;\n\tclassName?: string;\n}\n\nnamespace S {\n\texport const Canvas = styled.div`\n\t\tposition: relative;\n\t\tcursor: move;\n\t\toverflow: hidden;\n\t`;\n}\n\nexport class CanvasWidget extends React.Component<DiagramProps> {\n\tref: React.RefObject<HTMLDivElement>;\n\tkeyUp: any;\n\tkeyDown: any;\n\tcanvasListener: any;\n\n\tconstructor(props: DiagramProps) {\n\t\tsuper(props);\n\n\t\tthis.ref = React.createRef();\n\t\tthis.state = {\n\t\t\taction: null,\n\t\t\tdiagramEngineListener: null\n\t\t};\n\t}\n\n\tcomponentWillUnmount() {\n\t\tthis.props.engine.deregisterListener(this.canvasListener);\n\t\tthis.props.engine.setCanvas(null);\n\n\t\tdocument.removeEventListener('keyup', this.keyUp);\n\t\tdocument.removeEventListener('keydown', this.keyDown);\n\t}\n\n\tregisterCanvas() {\n\t\tthis.props.engine.setCanvas(this.ref.current);\n\t\tthis.props.engine.iterateListeners((list) => {\n\t\t\tlist.rendered && list.rendered();\n\t\t});\n\t}\n\n\tcomponentDidUpdate() {\n\t\tthis.registerCanvas();\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.canvasListener = this.props.engine.registerListener({\n\t\t\trepaintCanvas: () => {\n\t\t\t\tthis.forceUpdate();\n\t\t\t}\n\t\t});\n\n\t\tthis.keyDown = (event) => {\n\t\t\tthis.props.engine.getActionEventBus().fireAction({ event });\n\t\t};\n\t\tthis.keyUp = (event) => {\n\t\t\tthis.props.engine.getActionEventBus().fireAction({ event });\n\t\t};\n\n\t\tdocument.addEventListener('keyup', this.keyUp);\n\t\tdocument.addEventListener('keydown', this.keyDown);\n\t\tthis.registerCanvas();\n\t}\n\n\trender() {\n\t\tconst engine = this.props.engine;\n\t\tconst model = engine.getModel();\n\n\t\treturn (\n\t\t\t<S.Canvas\n\t\t\t\tclassName={this.props.className}\n\t\t\t\tref={this.ref}\n\t\t\t\tonWheel={(event) => {\n\t\t\t\t\tthis.props.engine.getActionEventBus().fireAction({ event });\n\t\t\t\t}}\n\t\t\t\tonMouseDown={(event) => {\n\t\t\t\t\tthis.props.engine.getActionEventBus().fireAction({ event });\n\t\t\t\t}}\n\t\t\t\tonMouseUp={(event) => {\n\t\t\t\t\tthis.props.engine.getActionEventBus().fireAction({ event });\n\t\t\t\t}}\n\t\t\t\tonMouseMove={(event) => {\n\t\t\t\t\tthis.props.engine.getActionEventBus().fireAction({ event });\n\t\t\t\t}}>\n\t\t\t\t{model.getLayers().map((layer) => {\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<TransformLayerWidget layer={layer} key={layer.getID()}>\n\t\t\t\t\t\t\t<SmartLayerWidget layer={layer} engine={this.props.engine} key={layer.getID()} />\n\t\t\t\t\t\t</TransformLayerWidget>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</S.Canvas>\n\t\t);\n\t}\n}\n","module.exports = require(\"@emotion/core\");","import * as React from 'react';\nimport { AbstractReactFactory, GenerateWidgetEvent } from '../../core/AbstractReactFactory';\nimport { SelectionLayerModel } from './SelectionLayerModel';\nimport { GenerateModelEvent } from '../../core/AbstractModelFactory';\nimport { SelectionBoxWidget } from './SelectionBoxWidget';\n\nexport class SelectionBoxLayerFactory extends AbstractReactFactory<SelectionLayerModel> {\n\tconstructor() {\n\t\tsuper('selection');\n\t}\n\n\tgenerateModel(event: GenerateModelEvent): SelectionLayerModel {\n\t\treturn new SelectionLayerModel();\n\t}\n\n\tgenerateReactWidget(event: GenerateWidgetEvent<SelectionLayerModel>): JSX.Element {\n\t\treturn <SelectionBoxWidget rect={event.model.box} />;\n\t}\n}\n","import * as React from 'react';\nimport * as _ from 'lodash';\nimport { BaseModel } from '../core-models/BaseModel';\n\nexport interface PeformanceWidgetProps {\n\tchildren: () => JSX.Element;\n\tserialized: object;\n\tmodel: BaseModel;\n}\n\nexport interface PeformanceWidgetState {}\n\nexport class PeformanceWidget extends React.Component<PeformanceWidgetProps, PeformanceWidgetState> {\n\tshouldComponentUpdate(\n\t\tnextProps: Readonly<PeformanceWidgetProps>,\n\t\tnextState: Readonly<PeformanceWidgetState>,\n\t\tnextContext: any\n\t): boolean {\n\t\tif (!this.props.model.performanceTune()) {\n\t\t\treturn true;\n\t\t}\n\t\t// deserialization event\n\t\tif (this.props.model !== nextProps.model) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// change event\n\t\treturn !_.isEqual(this.props.serialized, nextProps.serialized);\n\t}\n\n\trender() {\n\t\treturn this.props.children();\n\t}\n}\n","import { State } from '../core-state/State';\nimport { Action, ActionEvent, InputType } from '../core-actions/Action';\nimport { MouseEvent } from 'react';\nimport { DragCanvasState } from './DragCanvasState';\nimport { SelectingState } from './SelectingState';\nimport { MoveItemsState } from './MoveItemsState';\n\nexport class DefaultState extends State {\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'default'\n\t\t});\n\t\tthis.childStates = [new SelectingState()];\n\n\t\t// determine what was clicked on\n\t\tthis.registerAction(\n\t\t\tnew Action({\n\t\t\t\ttype: InputType.MOUSE_DOWN,\n\t\t\t\tfire: (event: ActionEvent<MouseEvent>) => {\n\t\t\t\t\tconst element = this.engine.getActionEventBus().getModelForEvent(event);\n\n\t\t\t\t\t// the canvas was clicked on, transition to the dragging canvas state\n\t\t\t\t\tif (!element) {\n\t\t\t\t\t\tthis.transitionWithEvent(new DragCanvasState(), event);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.transitionWithEvent(new MoveItemsState(), event);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t}\n}\n"],"sourceRoot":""}